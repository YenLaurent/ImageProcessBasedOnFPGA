# Image Process Based on FPGA

- [Image Process Based on FPGA](#image-process-based-on-fpga)
    - [简要介绍](#简要介绍)
    - [为什么采用FPGA进行预处理？](#为什么采用fpga进行预处理)
    - [后续的进一步计划](#后续的进一步计划)
    - [技术细节](#技术细节)
      - [SOBEL边缘检测](#sobel边缘检测)
      - [中值滤波](#中值滤波)
      - [彩色图像灰度化](#彩色图像灰度化)
    - [困难和解决办法](#困难和解决办法)
      - [系统架构与硬件划分](#系统架构与硬件划分)
      - [协同仿真](#协同仿真)
    - [模块划分](#模块划分)
    - [如何与上位机通信：采用何种通信协议](#如何与上位机通信采用何种通信协议)


***该项目依托于电子科技大学2024-2025学年“基于边缘计算的电瓶车闯红灯检测系统开发”大创项目***

### 简要介绍

该大创项目依托于电子科技大学集成电路学院“强芯育苗”科研计划，针对**现有交通监控系统对非机动车闯红灯行为检测效率低、实时性差**的问题，提出了一种**基于边缘计算的软硬件结合的人工智能实时监测系统**解决方案，通过FPGA采集道路图像信息并进行图像滤波预处理，将视频流数据送至上位机进行基于YOLO人工智能模型的实时边缘检测，实现对电瓶车闯红灯行为的自动检测与记录，解决了传统电子眼难以对非机动车进行准确的闯红灯识别的问题。

该项目确定了基于FPGA的边缘端预处理与上位机YOLO模型协同的系统架构。截至中期答辩，已实现基于FPGA的彩色图像灰度滤波、灰度图像中值滤波与SOBEL算子边缘检测处理，并进行了Python-Verilog协同仿真验证，在处理单帧尺寸为`200*200`的图像时，相对于传统的软件处理，在100MHz时钟下，该设计的处理延迟可提升约12.74%~28.70%。

### 为什么采用FPGA进行预处理？

**传统方法的局限性：**

传统的人工智能检测方法，通常是将不同交通路口的摄像头所采集的原始视频流，直接送至上位机，由CPU或GPU来进行所有的处理，包括图像预处理（如本项目所采用的灰度滤波、中值滤波、边缘检测）和后续的YOLO模型推理。这存在以下几个问题：

1. **上位机成为性能瓶颈**：图像预处理，特别是像中值滤波和Sobel边缘检测，本质上是大量、重复的像素级运算，如果完全采用上位机进行这些计算，外加后续需要进行的人工智能软件推理，对上位机的计算能力要求相对较高，在**低成本**下难以达到较低的推理**延迟**。
    > **注意**：这里FPGA图像预处理引擎可以分布在多个十字路口，处理后的视频流数据送至同一上位机，若不进行预处理，上位机的计算能力几乎必然成为瓶颈
2. **数据传输延迟与带宽压力**：未经处理的原始彩色视频数据量很大，从摄像头传输到上位机会**占用大量带宽**，并带来不可忽视的**延迟**，这同样不利于系统的实时响应。

**本解决方案的优势：**

采用FPGA进行图像预处理，结合上位机的YOLO人工智能软件推理，可以在相对**较低的成本**下实现**极低的处理延迟**，防止上位机的计算能力成为瓶颈，同时具备将FPGA图像预处理引擎分布式部署至多个红绿灯路口的**可拓展性**，可极大地**节约数据传输带宽**

### 后续的进一步计划

* 可以在FPGA硬件加速模块中进一步引入去雾、去雨等模块，以增强在不同天气条件下的识别能力

### 技术细节

#### SOBEL边缘检测

* **目的**是提取出视频图像的边缘特征，便于上位机进行快速推理

* **原因**是该算子较为常用，比较成熟，**效率较高**，且对**噪声容忍度较高**，适合本系统中的灰度渐变图像

一种通过寻找**图像一阶梯度最大值**来检测边界的算法

对灰度渐变和噪声较多的图像处理效果比较好，对边缘定位比较准确

SOBEL算子是一个离散的一阶差分算子，用来计算图像亮度函数的**一阶梯度近似值**

在图像的任何一点使用此算子，将会产生**该点对应的梯度**矢量

采用水平与竖直两个方向的尺寸为`3*3`的卷积核，与输入像素进行卷积，分别检测竖直与水平方向的边缘

> 垂直方向的边缘在水平方向的梯度(偏导数)幅值较大
>
> 水平方向的边缘在垂直方向的梯度(偏导数)幅值较大

在卷积结束后，得到水平与竖直两个方向的梯度$G_x, G_y$，随后，该点像素相对于邻近像素的近似梯度值即$G=\sqrt{G_x^2+G_y^2}$，这样便可将输入数据的特征提取出来了

> **二维离散卷积的规则**：矩阵元素对应相乘再相加，要求两个矩阵形状完全一致

#### 中值滤波

* **目的**是去除一定噪声，平滑边缘

即采用一定的滤波窗口尺寸，在该窗口中，中心像素值应当为窗口中所有像素值的中值

在本系统中，输入为串行的像素流，要实现与周边像素的比较，需要进行像素的行缓存

#### 彩色图像灰度化

* **目的**是减少无关信息，同时降低数据大小，减轻后续图像传输带宽要求

采用了平均值法与加权平均值法两种方法实现灰度滤波

### 困难和解决办法

#### 系统架构与硬件划分

在系统设计过程中，遇到的最主要困难是**系统架构与软硬件划分**的确定

其困难主要在于：

* 此前**没有**相关软硬件结合检测电瓶车闯红灯的**先例**
* 系统开发**成本**的折中：
    > **将整个YOLO模型部署至FPGA**：硬件成本较高、开发难度较大、不适合大规模应用于实际场景
* 系统**性能**的折中：
    > **完全以软件形式进行目标检测**：延迟较高、对上位机硬件要求较高、大规模部署下成本较高，且数据传输带宽成本较高

因此，需要考虑将部分计算分担至边缘端，采取“边缘端+云端”结合、软硬件结合的开发方式，实现了**成本与性能**的优化

> **为何选择将这些模块硬件化？**
>
> 因为这是在图像识别中常见的一些处理，将其硬件化后可以减轻上位机的计算负担

#### 协同仿真

还有一个困难是在Python-Verilog协同仿真过程中，如何利用Python软件代码实现行缓存（即如何实现**移位寄存器**）

**解决办法**：引入`collections.deque`，利用其双端队列的特性，模拟移位寄存器的功能

### 模块划分

* 软件端
* 硬件端
  * 视频流输入模块
  * 图像滤波模块
    * 彩色图像灰度化
    * 中值滤波
    * SOBEL边缘检测
  * 与上位机通信模块：拟采用以太网通信
  * 时钟产生模块

### 如何与上位机通信：采用何种通信协议

由于该项目的输入视频流在经过三大图像预处理模块后，变为了二值黑白数据输出，因此**位宽**较小

假如输入视频尺寸为`200*200`，则每帧数据量为`200*200*1bits = 40,000bits = 40kb`

在一般情况下，道路监控系统要求`30FPS`帧速率，因此，其传输**带宽**为
* `@30FPS: 40kb/frame * 30fps = 1.2Mbps`
* `@60FPS: 40kb/frame * 60fps = 2.4Mbps`

对于UART串口，其通常最高传输带宽为`115,200bps = 0.1152Mbps`，显然无法采用，尽管其实现较为简单

对于USB，其带宽很高，但不适合远距离传输，也难以拓展，与工程实际不符合

而以太网天然具备较高的传输带宽，并且具备**可拓展**属性，这与本项目以及实际的交通监控场景非常吻合，因此，采用**以太网**进行数据传输